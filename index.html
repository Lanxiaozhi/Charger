<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <title>城市电动汽车充电桩分布</title>
  <meta name="description" content="" />
  <meta name="author" content="damien" />

  <link rel="stylesheet" href="css/styles.css" type="text/css" />
  <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script src="https://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.js"></script>
  <script src="https://cdn.bootcss.com/PapaParse/4.3.7/papaparse.min.js"></script>
  <script src="js/e-smart-zoom-jquery.js"></script>

  <script>
    $(document).ready(function() {

      $('#imageFullScreen').smartZoom({'maxScale' : 8, 'containerClass':'zoomableContainer'});

      $('#topPositionMap,#leftPositionMap,#rightPositionMap,#bottomPositionMap').bind("click", moveButtonClickHandler);
      $('#zoomInButton,#zoomOutButton').bind("click", zoomButtonClickHandler);

      function zoomButtonClickHandler(e){
        var scaleToAdd = 0.8;
        if(e.target.id == 'zoomOutButton')
          scaleToAdd = -scaleToAdd;
        $('#imageFullScreen').smartZoom('zoom', scaleToAdd);
      }

      function moveButtonClickHandler(e){
        var pixelsToMoveOnX = 0;
        var pixelsToMoveOnY = 0;

        switch(e.target.id){
          case "leftPositionMap":
            pixelsToMoveOnX = 50;
            break;
          case "rightPositionMap":
            pixelsToMoveOnX = -50;
            break;
          case "topPositionMap":
            pixelsToMoveOnY = 50;
            break;
          case "bottomPositionMap":
            pixelsToMoveOnY = -50;
            break;
        }
        $('#imageFullScreen').smartZoom('pan', pixelsToMoveOnX, pixelsToMoveOnY);
      }


      var totalEvent = 0.1 * 24200000;
      var totalPile = 20000;
      var square = new Array();
      var a = new Object();
      for(var i=0;i<8000;i++){
        square[i] = new Object();
        square[i].prob = new Array();
      }
      var time = new Array();
      for(var i=0;i<24;i++){
        time[i] = new Array(4);
      }
      Papa.parse('csv/density.csv', {
        download: true,
        complete: function(results) {
          var data = results.data, html;
          for(var i = 1, _l = data.length-1; i < _l; i++) {
            var item = data[i];
            square[i-1].longitude = item[1];
            square[i-1].latitude = item[2];
            square[i-1].kind = item[3];
            square[i-1].density = item[4];
          }
          Papa.parse('csv/probability.csv', {
            download: true,
            complete: function(results) {
              var data = results.data, html;
              for(var i = 1, _l = data.length-1; i < _l; i++) {
                time[i-1] = data[i];
              }
            }
          });
        }
      });

      var totalRate = new Array();
      var pile = new Array();
      for(var i=0;i<7295;i++){
        var pile = Math.round(totalPile*square[i].density);
      }

      function calcRate(){
        var result = 0;
        for(var i=0;i<7925;i++){
          result += totalRate[i];
        }
        return result;
      }

      var currentRate = 10000;
      function calcPile() {
        calcEvent();
        while(1){
          if(currentRate < calcRate())
            break;
          adjustEvent();
          calcEvent();
          currentRate = calcRate();
        }
      }
      var order = new Array();
      function adjustEvent(){
        for(var i=0;i<7295;i++){
          order[i] = i;
        }
        var count = 0;
        for(var i=0;i<7295;i++){
          if(totalRate[i] > 0)
            count++;
        }
        for(var i=0;i<7295;i++){
          for(var j=0;j<i;j++){
            if(totalRate[i]>totalRate[j]){
              var temp1 = totalRate[i];
              var temp2 = order[i];
              totalRate[i] = totalRate[j];
              order[i] = order[j];
              totalRate[j] = temp1;
              order[j] = temp2;
            }
          }
        }
        for(var i=0;i<count/4;i++){
          pile[i]--;
          pile[count-i]++;
        }
      }

      function calcEvent() {
        for(var i=0;i<7295;i++){
          pile[i]=100;
          var event = new Array();
          var totalChargingTime = 0;
          var totalMiss = 0;
          var totalChargingEvent = 0;
          for(var j=0;j<24;j++){
            event[j] = new Object();
            event[j].toCharge = square[i].prob[j];
            event[j].newCharge = 0;
            event[j].charging = 0;
          }
          for(var j=0;j<24;j++){
            totalChargingEvent += event[j].toCharge;
            if(pile[i] - event[j].charging >= event[j].toCharge){
              event[j].charging += event[j].toCharge;
              event[j].newCharge = event[j].toCharge;
              totalChargingTime+=event[j].charging;
            }
            else{
              event[j].newCharge = pile[i] - event[j].charging;
              event[j].charging = pile[i];
              totalMiss += event[j].toCharge - event[j].newCharge;
            }
            for(var k=j+1;k<j+5;k++){
              if(k<24){
                event[k].charging += event[j].newCharge;
              }
            }
          }
          if(pile[i] > 0 && totalChargingEvent > 0) {
            var missRate = totalMiss / totalChargingEvent;
            var fillRate = totalChargingTime / pile[i] / 24;
            totalRate[i] = 0.5*fillRate + 0.5*missRate;
            console.log(totalRate[i]);
          }
        }
      }

      $("#page").hide();
      $("#calculate").click(function () {
        $("#input").hide();
        //totalPile = $("#total").val();
        for(var i=0;i<7295;i++){
          for(var j=0;j<24;j++){
            square[i].prob[j] = parseInt(square[i].density*totalEvent*time[j][square[i].kind]);
          }
        }
        calcEvent();
        $("#page").show();
      });
    });
  </script>
</head>
<body>
<header id="header">
  <div id="headerContainer">
    <h1 style="color:white;">城市电动汽车充电桩分布</h1>
  </div>
</header>
<div id="input">
  <div style="padding: 50px 100px 10px;">
    <form>
      <div class="col-md-4 col-md-offset-1 col-sm-4 col-sm-offset-1 col-xs-4 col-xs-offset-1">
        <div class="input-group input-group-lg">
          <span class="input-group-addon">总数</span>
          <input type="text" class="form-control" style="text-align:center;"
                 onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"
                 onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" id="total" placeholder="">
        </div>
      </div>
      <div class="col-md-4 col-sm-4 col-xs-4">
        <div class="input-group input-group-lg">
          <span class="input-group-addon">比例</span>
          <input type="text" class="form-control" style="text-align:center;" onkeyup="if(isNaN(value))execCommand('undo')"
                 onafterpaste="if(isNaN(value))execCommand('undo')" id="rate" placeholder="">
        </div>
      </div>
      <div class="col-md-1 col-sm-1 col-xs-1">
        <button type="button" id="calculate" class="btn btn-primary btn-lg">
          <i class="fa fa-dashboard"></i> 计算
        </button>
      </div>
    </form>
  </div>
</div>
<div id="page">

  <div id="pageContent">
    <div id="imgContainer">
      <img id="imageFullScreen" src="src/map.jpg"/>
    </div>
    <div id="positionButtonDiv">
      <p>缩放 :
        <span>
          <img id="zoomInButton" class="zoomButton" src="src/zoomIn.png" title="zoom in" alt="zoom in" />
          <img id="zoomOutButton" class="zoomButton" src="src/zoomOut.png" title="zoom out" alt="zoom out" />
        </span>
      </p>
      <p>
        <span class="positionButtonSpan">
          <map name="positionMap" class="positionMapClass">
            <area id="topPositionMap" shape="rect" coords="20,0,40,20" title="move up" alt="move up"/>
            <area id="leftPositionMap" shape="rect" coords="0,20,20,40" title="move left" alt="move left"/>
            <area id="rightPositionMap" shape="rect" coords="40,20,60,40" title="move right" alt="move right"/>
            <area id="bottomPositionMap" shape="rect" coords="20,40,40,60" title="move bottom" alt="move bottom"/>
          </map>
          <img src="src/position.png" usemap="#positionMap" />
        </span>
      </p>
    </div>
  </div>
  <div style="padding: 600px 100px 10px;">
    <form>
      <div class="col-md-5 col-md-offset-2 col-sm-5 col-sm-offset-2 col-xs-5 col-xs-offset-2">
        <div class="input-group input-group-lg">
          <span class="input-group-addon">所选位置</span>
          <input type="text" class="form-control" style="text-align:center;" disabled="disabled" id="position" placeholder="">
        </div>
      </div>
      <div class="col-md-3 col-sm-3 col-xs-3">
        <div class="input-group input-group-lg">
          <span class="input-group-addon">序号</span>
          <input type="text" class="form-control" style="text-align:center;" disabled="disabled" id="order" placeholder="">
        </div>
      </div>
    </form>
    <div style="height:50px;"></div>
    <form>
      <div class="col-md-6 col-md-offset-3 col-sm-6 col-sm-offset-3 col-xs-6 col-xs-offset-3">
        <div class="input-group input-group-lg">
          <span class="input-group-addon">数量</span>
          <input type="text" class="form-control" style="text-align:center;" disabled="disabled" id="number" placeholder="">
        </div>
      </div>
    </form>
  </div>
</div>

<footer>
</footer>

</body>
</html>
